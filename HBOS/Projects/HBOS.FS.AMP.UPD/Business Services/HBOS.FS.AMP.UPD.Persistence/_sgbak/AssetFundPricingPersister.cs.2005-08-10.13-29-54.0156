using System.Data;
using System.Data.SqlClient;
using HBOS.FS.AMP.UPD.Exceptions;
using HBOS.FS.AMP.UPD.Types.AssetFunds;
using HBOS.FS.Support.Tex;

namespace HBOS.FS.AMP.UPD.Persistence
{
	/// <summary>
	/// Summary description for AssetFundPricingPersister.
	/// </summary>
	public class AssetFundPricingPersister : AssetFundPersister
	{
		/// <summary>
		/// 
		/// </summary>
		/// <param name="connectionString"></param>
		public AssetFundPricingPersister(string connectionString) : base(connectionString)
		{
		}


		/// <summary>
		/// Creates a user from the supplied data
		/// </summary>
		/// <param name="reader">The reader containing the data.</param>
		/// <returns></returns>
		protected override object CreateEntity(SafeDataReader reader)
		{
			AssetFund newAssetFund = createHeavyEntity(reader);
			T.E();
			logAssetFundLoad(newAssetFund);
			T.X();
			return newAssetFund;
		}

		/// <summary>
		/// This method returns a collection of asset funds based upon a particualr key
		/// Used for the light object collection (no weithing collections etc)
		/// </summary>
		/// <param name="assetFundCode"></param>
		/// <param name="fundGroupID"></param>
		/// <param name="companyCode"></param>
		/// <returns></returns>
		/// <exception cref="DatabaseException">Unable to load items</exception>
		private AssetFundCollection USPAssetFundDetailsHeavy(string assetFundCode, int fundGroupID, string companyCode)
		{
			// This method handles the call to the usp_AssetFundDetailsForAssetFundID
			// This saves repeating it in different places when it is doing the same thing


			//TODO - currently only the light method can be called
			//	throw new NotImplementedException ("AssetFundPersister Refactored Stored Procedure unavailable for full asset fund details");


			T.E();
			string loadSp = "usp_AssetFundsGetPriceDetailsForCompany"; //"kaj_AssetFundDetails";
			AssetFundCollection assetFunds = new AssetFundCollection();
			SqlParameter[] parameters = new SqlParameter[1];
			try
			{
				// Set up the parameters.
				if (assetFundCode.Length > 0)
				{
					loadSp = "usp_AssetFundsGetPriceDetailsForAssetFundID";
					parameters[0] = new SqlParameter("@cAssetFundID", SqlDbType.Char, 8);
					parameters[0].Value = assetFundCode;
				}
				else if (fundGroupID > 0)
				{
					loadSp = "usp_AssetFundsGetPriceDetailsForFundGroupID";
					parameters[0] = new SqlParameter("@iFundGroupID", SqlDbType.Int);
					parameters[0].Value = fundGroupID;
				}
				else
				{
					parameters[0] = new SqlParameter("@cCompanyCode", SqlDbType.VarChar, 10);
					parameters[0].Value = companyCode;
				}

				this.LoadEntityCollection(loadSp, parameters, assetFunds);
			}
			finally
			{
				T.X();
			}
			return assetFunds;

		}

		/// <summary>
		/// Loads a particular asset fund
		/// Loads the heavy object version - all data
		/// </summary>
		/// <param name="assetFundCode">The Hi3 code (??) for the asset fund</param>
		/// <param name="currentFactors">Indicates whether to load the current factors</param>
		/// <returns>The requested asset fund</returns>
		/// <exception cref="DatabaseException">Unable to load item</exception>
		/// <exception cref="InvalidSqlParameterException">Attempt to call stored proc with an invalid parameter</exception>
		public AssetFund Load(string assetFundCode, bool currentFactors)
		{
			AssetFundCollection assetFunds;

			T.E();
			try
			{
				assetFunds = USPAssetFundDetailsHeavy(assetFundCode, 0, string.Empty);

				// Check that there is one and only one.
				if (assetFunds.Count != 1)
				{
					throw new DatabaseException("The Asset Fund object was not found.");
				}
			}
			finally
			{
				T.X();
			}
			return assetFunds[0];
		}

		/// <summary>
		/// Returns the collection of Fund objects for the given company.
		/// Loads the heavy object version - all data
		/// </summary>
		/// <param name="companyCode">The ID of the company for which the funds are to be retrieved</param>
		/// <param name="currentWeightings">Indicates whether to load the current weightings</param>
		/// <returns type="AssetFundCollection">A collection of asset funds for the company</returns>
		/// <exception cref="DatabaseException">Unable to load item</exception>
		/// <exception cref="InvalidSqlParameterException">Attempt to call stored proc with an invalid parameter</exception>
		public AssetFundCollection LoadForCompany(string companyCode, bool currentWeightings)
		{
			AssetFundCollection assetFunds;

			assetFunds = USPAssetFundDetailsHeavy(string.Empty, 0, companyCode);

			return assetFunds;
		}

		/// <summary>
		/// Returns the collection of Fund objects for the given fund group id.
		/// Loads the heavy object version - all data
		/// </summary>
		/// <param name="fundGroupID">The ID of the fund group for which the funds are to be retrieved</param>
		/// <param name="currentWeightings">Indicates whether to load the current weightings</param>
		/// <returns type="AssetFundCollection">A collection of asset funds for the fund group</returns>
		/// <exception cref="DatabaseException">Unable to load item</exception>
		public AssetFundCollection Load(int fundGroupID, bool currentWeightings)
		{
			AssetFundCollection assetFunds;
			T.E();
			try
			{
				assetFunds = USPAssetFundDetailsHeavy(string.Empty, fundGroupID, string.Empty);
			}
			finally
			{
				T.X();
			}

			return assetFunds;
		}

		private AssetFund createHeavyEntity(SafeDataReader reader)
		{
			T.E();
			AssetFund newAssetFund = null;
			try
			{
				//retrieve fund type from db and create appropriate asset fund type based on this.
				AssetFund.AssetFundTypeEnum assetFundType = resolveDBTypeToAssetFundType(reader.GetString("fundType"));
				//TODO - also, load asset fund group collection
				//TODO - old collections in factory method can go

				//TODO - authorisedAssetFundPriceID, tolerancesID not used

				string assetFundID = reader.GetString("assetFundID");

				//Create objects representing the Market Value splits related to this Asset Fund
//				AssetFundIndexWeightedPersister assetFundIndexWeightedPersister = new AssetFundIndexWeightedPersister(m_connectionString);
				//TODO - these no longer used
				//AssetFundIndexWeightedCollection marketValueSplits = null;
				//AssetFundIndexWeightedCollection marketValueSplits = assetFundIndexWeightedPersister.LoadWeightedIndicesForAssetFund(assetFundID);

				//Create objects representing the Weighted Indices Values related to this Asset Fund
				//TODO - these no longer used
				AssetMovementConstituentCollection assetMovementConstituents= new AssetMovementConstituentCollection();

				// TODO: Discuss with Kevin - what was meant here?
				// Valuation point is never set and these indices are they what we are 
				// trying to achieve by the boolean flag on the stored previous procedure call?

			//	AssetFundIndexWeightedPersister weightedIndexPersister = new AssetFundIndexWeightedPersister(this.ConnectionString);
				//TODO - these no longer used
				//weightedIndices = weightedIndexPersister.LoadWeightedIndicesForAssetFund(assetFundID);

//reader.GetInt64("currencyRateSnapshotID"), !reader.IsNull("currencyRateSnapshotID"),
//				                            reader.GetInt64("importedIndexValueID"), !reader.IsNull("importedIndexValueID"), reader.GetInt64("fundIndexWeightingsID"),
//				                            !reader.IsNull("fundIndexWeightingsID"), reader.GetInt64("compositeFundSplitImportID"), !reader.IsNull("compositeFundSplitImportID"),

				//TODO set auth price and auth price set
				newAssetFund = new AssetFund(assetFundType, assetFundID,
				                            reader.GetString("shortName"), reader.GetString("fullName"), reader.GetString("CompanyCode"), reader.GetDecimal("assetUnitPrice"),
				                            reader.GetDateTime("assetUnitPriceValuationPoint"),reader.GetDecimal("assetUnitPriceMovement"), reader.GetDecimal("previousAssetUnitPrice"), !reader.IsNull("previousAssetUnitPrice"),
				                            0M, false,reader.GetBoolean("assetFundLocked") ,reader.GetDecimal("assetMovementTolerance"),
											!reader.IsNull("assetUnitPrice"),!reader.IsNull("assetUnitPriceMovement"),!reader.IsNull("assetMovementTolerance"), !reader.IsNull("assetUnitPriceValuationPoint"),
				                            reader.GetTimestamp("ts"),assetMovementConstituents,null);

				//TODO - currently only the light method can be called
				//throw new NotImplementedException ("AssetFundPersister Refactored Stored Procedure unavailable for full asset fund details");
			}
			finally
			{
				T.X();
			}
			return newAssetFund;
		}


	}
}